function c(r){return typeof r=="function"}function M(r){let t=r(o=>{Error.call(o),o.stack=new Error().stack});return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var y=M(r=>function(t){r(this),this.message=t?`${t.length} errors occurred during unsubscription:
${t.map((o,i)=>`${i+1}) ${o.toString()}`).join(`
  `)}`:"",this.name="UnsubscriptionError",this.errors=t});function x(r,e){if(r){let t=r.indexOf(e);0<=t&&r.splice(t,1)}}var p=class r{constructor(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let e;if(!this.closed){this.closed=!0;let{_parentage:t}=this;if(t)if(this._parentage=null,Array.isArray(t))for(let s of t)s.remove(this);else t.remove(this);let{initialTeardown:o}=this;if(c(o))try{o()}catch(s){e=s instanceof y?s.errors:[s]}let{_finalizers:i}=this;if(i){this._finalizers=null;for(let s of i)try{U(s)}catch(n){e=e??[],n instanceof y?e=[...e,...n.errors]:e.push(n)}}if(e)throw new y(e)}}add(e){var t;if(e&&e!==this)if(this.closed)U(e);else{if(e instanceof r){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}}_hasParent(e){let{_parentage:t}=this;return t===e||Array.isArray(t)&&t.includes(e)}_addParent(e){let{_parentage:t}=this;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e}_removeParent(e){let{_parentage:t}=this;t===e?this._parentage=null:Array.isArray(t)&&x(t,e)}remove(e){let{_finalizers:t}=this;t&&x(t,e),e instanceof r&&e._removeParent(this)}};p.EMPTY=(()=>{let r=new p;return r.closed=!0,r})();var ae=p.EMPTY;function g(r){return r instanceof p||r&&"closed"in r&&c(r.remove)&&c(r.add)&&c(r.unsubscribe)}function U(r){c(r)?r():r.unsubscribe()}var u={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1};var f={setTimeout(r,e,...t){let{delegate:o}=f;return o?.setTimeout?o.setTimeout(r,e,...t):setTimeout(r,e,...t)},clearTimeout(r){let{delegate:e}=f;return(e?.clearTimeout||clearTimeout)(r)},delegate:void 0};function R(r){f.setTimeout(()=>{let{onUnhandledError:e}=u;if(e)e(r);else throw r})}function A(){}var z=_("C",void 0,void 0);function O(r){return _("E",void 0,r)}function D(r){return _("N",r,void 0)}function _(r,e,t){return{kind:r,value:e,error:t}}var a=null;function N(r){if(u.useDeprecatedSynchronousErrorHandling){let e=!a;if(e&&(a={errorThrown:!1,error:null}),r(),e){let{errorThrown:t,error:o}=a;if(a=null,t)throw o}}else r()}function B(r){u.useDeprecatedSynchronousErrorHandling&&a&&(a.errorThrown=!0,a.error=r)}var b=class extends p{constructor(e){super(),this.isStopped=!1,e?(this.destination=e,g(e)&&e.add(this)):this.destination=Q}static create(e,t,o){return new l(e,t,o)}next(e){this.isStopped?W(D(e),this):this._next(e)}error(e){this.isStopped?W(O(e),this):(this.isStopped=!0,this._error(e))}complete(){this.isStopped?W(z,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(e){this.destination.next(e)}_error(e){try{this.destination.error(e)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}},J=Function.prototype.bind;function P(r,e){return J.call(r,e)}var I=class{constructor(e){this.partialObserver=e}next(e){let{partialObserver:t}=this;if(t.next)try{t.next(e)}catch(o){T(o)}}error(e){let{partialObserver:t}=this;if(t.error)try{t.error(e)}catch(o){T(o)}else T(e)}complete(){let{partialObserver:e}=this;if(e.complete)try{e.complete()}catch(t){T(t)}}},l=class extends b{constructor(e,t,o){super();let i;if(c(e)||!e)i={next:e??void 0,error:t??void 0,complete:o??void 0};else{let s;this&&u.useDeprecatedNextContext?(s=Object.create(e),s.unsubscribe=()=>this.unsubscribe(),i={next:e.next&&P(e.next,s),error:e.error&&P(e.error,s),complete:e.complete&&P(e.complete,s)}):i=e}this.destination=new I(i)}};function T(r){u.useDeprecatedSynchronousErrorHandling?B(r):R(r)}function G(r){throw r}function W(r,e){let{onStoppedNotification:t}=u;t&&f.setTimeout(()=>t(r,e))}var Q={closed:!0,next:A,error:G,complete:A};var L=typeof Symbol=="function"&&Symbol.observable||"@@observable";function V(r){return r}function j(r){return r.length===0?V:r.length===1?r[0]:function(t){return r.reduce((o,i)=>i(o),t)}}var h=class r{constructor(e){e&&(this._subscribe=e)}lift(e){let t=new r;return t.source=this,t.operator=e,t}subscribe(e,t,o){let i=Z(e)?e:new l(e,t,o);return N(()=>{let{operator:s,source:n}=this;i.add(s?s.call(i,n):n?this._subscribe(i):this._trySubscribe(i))}),i}_trySubscribe(e){try{return this._subscribe(e)}catch(t){e.error(t)}}forEach(e,t){return t=q(t),new t((o,i)=>{let s=new l({next:n=>{try{e(n)}catch(K){i(K),s.unsubscribe()}},error:i,complete:o});this.subscribe(s)})}_subscribe(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)}[L](){return this}pipe(...e){return j(e)(this)}toPromise(e){return e=q(e),new e((t,o)=>{let i;this.subscribe(s=>i=s,s=>o(s),()=>t(i))})}};h.create=r=>new h(r);function q(r){var e;return(e=r??u.Promise)!==null&&e!==void 0?e:Promise}function X(r){return r&&c(r.next)&&c(r.error)&&c(r.complete)}function Z(r){return r&&r instanceof b||X(r)&&g(r)}var F={now(){return(F.delegate||Date).now()},delegate:void 0};var w=class extends p{constructor(e,t){super()}schedule(e,t=0){return this}};var v={setInterval(r,e,...t){let{delegate:o}=v;return o?.setInterval?o.setInterval(r,e,...t):setInterval(r,e,...t)},clearInterval(r){let{delegate:e}=v;return(e?.clearInterval||clearInterval)(r)},delegate:void 0};var k=class extends w{constructor(e,t){super(e,t),this.scheduler=e,this.work=t,this.pending=!1}schedule(e,t=0){var o;if(this.closed)return this;this.state=e;let i=this.id,s=this.scheduler;return i!=null&&(this.id=this.recycleAsyncId(s,i,t)),this.pending=!0,this.delay=t,this.id=(o=this.id)!==null&&o!==void 0?o:this.requestAsyncId(s,this.id,t),this}requestAsyncId(e,t,o=0){return v.setInterval(e.flush.bind(e,this),o)}recycleAsyncId(e,t,o=0){if(o!=null&&this.delay===o&&this.pending===!1)return t;t!=null&&v.clearInterval(t)}execute(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;let o=this._execute(e,t);if(o)return o;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(e,t){let o=!1,i;try{this.work(e)}catch(s){o=!0,i=s||new Error("Scheduled action threw falsy error")}if(o)return this.unsubscribe(),i}unsubscribe(){if(!this.closed){let{id:e,scheduler:t}=this,{actions:o}=t;this.work=this.state=this.scheduler=null,this.pending=!1,x(o,this),e!=null&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null,super.unsubscribe()}}};var d=class r{constructor(e,t=r.now){this.schedulerActionCtor=e,this.now=t}schedule(e,t=0,o){return new this.schedulerActionCtor(this,e).schedule(o,t)}};d.now=F.now;var S=class extends d{constructor(e,t=d.now){super(e,t),this.actions=[],this._active=!1}flush(e){let{actions:t}=this;if(this._active){t.push(e);return}let o;this._active=!0;do if(o=e.execute(e.state,e.delay))break;while(e=t.shift());if(this._active=!1,o){for(;e=t.shift();)e.unsubscribe();throw o}}};var ee=new S(k),H=ee;function Y(r){return r&&c(r.schedule)}function $(r){return r instanceof Date&&!isNaN(r)}function E(r=0,e,t=H){let o=-1;return e!=null&&(Y(e)?t=e:o=e),new h(i=>{let s=$(r)?+r-t.now():r;s<0&&(s=0);let n=0;return t.schedule(function(){i.closed||(i.next(n++),0<=o?this.schedule(void 0,o):i.complete())},s)})}var te=(n=>(n[n.Start=0]="Start",n[n.Stop=1]="Stop",n[n.Pause=2]="Pause",n[n.Resume=3]="Resume",n[n.Rewind=4]="Rewind",n[n.Forward=5]="Forward",n))(te||{}),C=class{constructor(e){this.activeWorkout=e}timer;subscription;workoutTimeline=[];currentActivityPointer=0;lastTick=0;pausedAtTick=0;start(){this.createWorkoutTimeline(),this.timer=E(0,1e3),this.subscription=this.timer.subscribe(e=>this.onTick(e)),this.publishCurrentActivity()}stop(){this.subscription?.unsubscribe(),this.timer=void 0}pause(){this.pausedAtTick=this.lastTick,this.stop()}resume(){this.timer=E(0,1e3),this.subscription=this.timer.subscribe(e=>this.onTick(e))}rewind(){this.pause();let e=!1,t=this.workoutTimeline[this.currentActivityPointer];t.remainingSeconds<t.length?(this.pausedAtTick-=t.length-t.remainingSeconds,this.lastTick-=t.length-t.remainingSeconds,t.remainingSeconds=t.length,e=!0):this.currentActivityPointer-1>=0&&(this.currentActivityPointer--,t=this.workoutTimeline[this.currentActivityPointer],t.remainingSeconds=t.length,this.pausedAtTick-=t.length,this.lastTick-=t.length,e=!0),e&&this.publishCurrentActivity()}forward(){this.pause();let e=!1,t=this.workoutTimeline[this.currentActivityPointer];this.currentActivityPointer+1<this.workoutTimeline.length?(t.remainingSeconds<t.length?(this.pausedAtTick+=t.remainingSeconds,this.lastTick+=t.remainingSeconds):(this.pausedAtTick+=t.length,this.lastTick+=t.length),t.remainingSeconds=0,this.currentActivityPointer++,t=this.workoutTimeline[this.currentActivityPointer],e=!0):t.remainingSeconds<t.length&&(this.pausedAtTick+=t.remainingSeconds,this.lastTick+=t.remainingSeconds,t.remainingSeconds=0,e=!0),e&&this.publishCurrentActivity()}onTick(e){this.lastTick=this.calculateCounter(e);let t=this.workoutTimeline[this.currentActivityPointer],o=t.finishTimestamp-this.lastTick;t.remainingSeconds=o,o===0&&this.currentActivityPointer++,this.currentActivityPointer<this.workoutTimeline.length?this.publishCurrentActivity():(this.stop(),this.currentActivityPointer--,this.publishFinalActivity())}publishCurrentActivity(){postMessage({workoutActivity:this.workoutTimeline[this.currentActivityPointer],isWorkoutFinished:!1})}publishFinalActivity(){postMessage({workoutActivity:this.workoutTimeline[this.workoutTimeline.length-1],isWorkoutFinished:!0})}calculateCounter(e){return this.pausedAtTick+e}createWorkoutTimeline(){let e=0;this.activeWorkout.schedule.preparationTime&&(e+=this.activeWorkout.schedule.preparationTime,this.workoutTimeline.push({type:0,finishTimestamp:e,remainingSeconds:this.activeWorkout.schedule.preparationTime,length:this.activeWorkout.schedule.preparationTime,set:1,activity:1}));for(let t=0;t<this.activeWorkout.schedule.numberOfSets;t++)for(let o=0;o<this.activeWorkout.schedule.numberOfExercises;o++)e+=this.activeWorkout.schedule.workoutTime,this.workoutTimeline.push({type:1,finishTimestamp:e,remainingSeconds:this.activeWorkout.schedule.workoutTime,length:this.activeWorkout.schedule.workoutTime,set:t+1,activity:o+1}),o<this.activeWorkout.schedule.numberOfExercises-1?(e+=this.activeWorkout.schedule.restTime,this.workoutTimeline.push({type:2,finishTimestamp:e,remainingSeconds:this.activeWorkout.schedule.restTime,length:this.activeWorkout.schedule.restTime,set:t+1,activity:o+1})):t<this.activeWorkout.schedule.numberOfSets-1&&(e+=this.activeWorkout.schedule.restTimeBetweenSets,this.workoutTimeline.push({type:3,finishTimestamp:e,remainingSeconds:this.activeWorkout.schedule.restTimeBetweenSets,length:this.activeWorkout.schedule.restTimeBetweenSets,set:t+1,activity:o+1}))}},m;addEventListener("message",({data:r})=>{switch(r?.command){case 0:r.workout&&(m=new C(r?.workout),m.start());break;case 1:m?.stop();break;case 2:m?.pause();break;case 3:m?.resume();break;case 4:m?.rewind();break;case 5:m?.forward();break;default:console.log(`Unknown command: ${r}`)}});export{te as WorkoutRunnerCommand};
