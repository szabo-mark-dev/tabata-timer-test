function c(r){return typeof r=="function"}function C(r){let t=r(o=>{Error.call(o),o.stack=new Error().stack});return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var v=C(r=>function(t){r(this),this.message=t?`${t.length} errors occurred during unsubscription:
${t.map((o,i)=>`${i+1}) ${o.toString()}`).join(`
  `)}`:"",this.name="UnsubscriptionError",this.errors=t});function d(r,e){if(r){let t=r.indexOf(e);0<=t&&r.splice(t,1)}}var p=class r{constructor(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let e;if(!this.closed){this.closed=!0;let{_parentage:t}=this;if(t)if(this._parentage=null,Array.isArray(t))for(let s of t)s.remove(this);else t.remove(this);let{initialTeardown:o}=this;if(c(o))try{o()}catch(s){e=s instanceof v?s.errors:[s]}let{_finalizers:i}=this;if(i){this._finalizers=null;for(let s of i)try{M(s)}catch(n){e=e??[],n instanceof v?e=[...e,...n.errors]:e.push(n)}}if(e)throw new v(e)}}add(e){var t;if(e&&e!==this)if(this.closed)M(e);else{if(e instanceof r){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}}_hasParent(e){let{_parentage:t}=this;return t===e||Array.isArray(t)&&t.includes(e)}_addParent(e){let{_parentage:t}=this;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e}_removeParent(e){let{_parentage:t}=this;t===e?this._parentage=null:Array.isArray(t)&&d(t,e)}remove(e){let{_finalizers:t}=this;t&&d(t,e),e instanceof r&&e._removeParent(this)}};p.EMPTY=(()=>{let r=new p;return r.closed=!0,r})();var pe=p.EMPTY;function y(r){return r instanceof p||r&&"closed"in r&&c(r.remove)&&c(r.add)&&c(r.unsubscribe)}function M(r){c(r)?r():r.unsubscribe()}var u={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1};var m={setTimeout(r,e,...t){let{delegate:o}=m;return o?.setTimeout?o.setTimeout(r,e,...t):setTimeout(r,e,...t)},clearTimeout(r){let{delegate:e}=m;return(e?.clearTimeout||clearTimeout)(r)},delegate:void 0};function R(r){m.setTimeout(()=>{let{onUnhandledError:e}=u;if(e)e(r);else throw r})}function E(){}var U=A("C",void 0,void 0);function z(r){return A("E",void 0,r)}function O(r){return A("N",r,void 0)}function A(r,e,t){return{kind:r,value:e,error:t}}var a=null;function B(r){if(u.useDeprecatedSynchronousErrorHandling){let e=!a;if(e&&(a={errorThrown:!1,error:null}),r(),e){let{errorThrown:t,error:o}=a;if(a=null,t)throw o}}else r()}function D(r){u.useDeprecatedSynchronousErrorHandling&&a&&(a.errorThrown=!0,a.error=r)}var x=class extends p{constructor(e){super(),this.isStopped=!1,e?(this.destination=e,y(e)&&e.add(this)):this.destination=G}static create(e,t,o){return new f(e,t,o)}next(e){this.isStopped?P(O(e),this):this._next(e)}error(e){this.isStopped?P(z(e),this):(this.isStopped=!0,this._error(e))}complete(){this.isStopped?P(U,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(e){this.destination.next(e)}_error(e){try{this.destination.error(e)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}},K=Function.prototype.bind;function _(r,e){return K.call(r,e)}var W=class{constructor(e){this.partialObserver=e}next(e){let{partialObserver:t}=this;if(t.next)try{t.next(e)}catch(o){g(o)}}error(e){let{partialObserver:t}=this;if(t.error)try{t.error(e)}catch(o){g(o)}else g(e)}complete(){let{partialObserver:e}=this;if(e.complete)try{e.complete()}catch(t){g(t)}}},f=class extends x{constructor(e,t,o){super();let i;if(c(e)||!e)i={next:e??void 0,error:t??void 0,complete:o??void 0};else{let s;this&&u.useDeprecatedNextContext?(s=Object.create(e),s.unsubscribe=()=>this.unsubscribe(),i={next:e.next&&_(e.next,s),error:e.error&&_(e.error,s),complete:e.complete&&_(e.complete,s)}):i=e}this.destination=new W(i)}};function g(r){u.useDeprecatedSynchronousErrorHandling?D(r):R(r)}function J(r){throw r}function P(r,e){let{onStoppedNotification:t}=u;t&&m.setTimeout(()=>t(r,e))}var G={closed:!0,next:E,error:J,complete:E};var N=typeof Symbol=="function"&&Symbol.observable||"@@observable";function L(r){return r}function V(r){return r.length===0?L:r.length===1?r[0]:function(t){return r.reduce((o,i)=>i(o),t)}}var l=class r{constructor(e){e&&(this._subscribe=e)}lift(e){let t=new r;return t.source=this,t.operator=e,t}subscribe(e,t,o){let i=X(e)?e:new f(e,t,o);return B(()=>{let{operator:s,source:n}=this;i.add(s?s.call(i,n):n?this._subscribe(i):this._trySubscribe(i))}),i}_trySubscribe(e){try{return this._subscribe(e)}catch(t){e.error(t)}}forEach(e,t){return t=j(t),new t((o,i)=>{let s=new f({next:n=>{try{e(n)}catch($){i($),s.unsubscribe()}},error:i,complete:o});this.subscribe(s)})}_subscribe(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)}[N](){return this}pipe(...e){return V(e)(this)}toPromise(e){return e=j(e),new e((t,o)=>{let i;this.subscribe(s=>i=s,s=>o(s),()=>t(i))})}};l.create=r=>new l(r);function j(r){var e;return(e=r??u.Promise)!==null&&e!==void 0?e:Promise}function Q(r){return r&&c(r.next)&&c(r.error)&&c(r.complete)}function X(r){return r&&r instanceof x||Q(r)&&y(r)}var I={now(){return(I.delegate||Date).now()},delegate:void 0};var T=class extends p{constructor(e,t){super()}schedule(e,t=0){return this}};var b={setInterval(r,e,...t){let{delegate:o}=b;return o?.setInterval?o.setInterval(r,e,...t):setInterval(r,e,...t)},clearInterval(r){let{delegate:e}=b;return(e?.clearInterval||clearInterval)(r)},delegate:void 0};var w=class extends T{constructor(e,t){super(e,t),this.scheduler=e,this.work=t,this.pending=!1}schedule(e,t=0){var o;if(this.closed)return this;this.state=e;let i=this.id,s=this.scheduler;return i!=null&&(this.id=this.recycleAsyncId(s,i,t)),this.pending=!0,this.delay=t,this.id=(o=this.id)!==null&&o!==void 0?o:this.requestAsyncId(s,this.id,t),this}requestAsyncId(e,t,o=0){return b.setInterval(e.flush.bind(e,this),o)}recycleAsyncId(e,t,o=0){if(o!=null&&this.delay===o&&this.pending===!1)return t;t!=null&&b.clearInterval(t)}execute(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;let o=this._execute(e,t);if(o)return o;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(e,t){let o=!1,i;try{this.work(e)}catch(s){o=!0,i=s||new Error("Scheduled action threw falsy error")}if(o)return this.unsubscribe(),i}unsubscribe(){if(!this.closed){let{id:e,scheduler:t}=this,{actions:o}=t;this.work=this.state=this.scheduler=null,this.pending=!1,d(o,this),e!=null&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null,super.unsubscribe()}}};var h=class r{constructor(e,t=r.now){this.schedulerActionCtor=e,this.now=t}schedule(e,t=0,o){return new this.schedulerActionCtor(this,e).schedule(o,t)}};h.now=I.now;var k=class extends h{constructor(e,t=h.now){super(e,t),this.actions=[],this._active=!1}flush(e){let{actions:t}=this;if(this._active){t.push(e);return}let o;this._active=!0;do if(o=e.execute(e.state,e.delay))break;while(e=t.shift());if(this._active=!1,o){for(;e=t.shift();)e.unsubscribe();throw o}}};var Z=new k(w),q=Z;function H(r){return r&&c(r.schedule)}function Y(r){return r instanceof Date&&!isNaN(r)}function S(r=0,e,t=q){let o=-1;return e!=null&&(H(e)?t=e:o=e),new l(i=>{let s=Y(r)?+r-t.now():r;s<0&&(s=0);let n=0;return t.schedule(function(){i.closed||(i.next(n++),0<=o?this.schedule(void 0,o):i.complete())},s)})}var ee=(n=>(n[n.Start=0]="Start",n[n.Stop=1]="Stop",n[n.Pause=2]="Pause",n[n.Resume=3]="Resume",n[n.Rewind=4]="Rewind",n[n.Forward=5]="Forward",n))(ee||{}),F=class{constructor(e){this.activeWorkout=e}timer;subscription;workoutTimeline=[];currentActivityPointer=0;lastTick=0;pausedAtTick=0;start(){this.createWorkoutTimeline(),this.timer=S(0,1e3),this.subscription=this.timer.subscribe(e=>this.onTick(e)),this.publishCurrentActivity()}stop(){this.subscription?.unsubscribe(),this.timer=void 0}pause(){this.pausedAtTick=this.lastTick,this.stop()}resume(){this.timer=S(0,1e3),this.subscription=this.timer.subscribe(e=>this.onTick(e))}rewind(){this.pause();let e=!1,t=this.workoutTimeline[this.currentActivityPointer];t.remainingSeconds<t.length?(this.pausedAtTick-=t.length-t.remainingSeconds,this.lastTick-=t.length-t.remainingSeconds,t.remainingSeconds=t.length,e=!0):this.currentActivityPointer-1>=0&&(this.currentActivityPointer--,t=this.workoutTimeline[this.currentActivityPointer],t.remainingSeconds=t.length,this.pausedAtTick-=t.length,this.lastTick-=t.length,e=!0),e&&this.publishCurrentActivity()}forward(){this.pause();let e=!1,t=this.workoutTimeline[this.currentActivityPointer];this.currentActivityPointer+1<this.workoutTimeline.length?(t.remainingSeconds<t.length?(this.pausedAtTick+=t.remainingSeconds,this.lastTick+=t.remainingSeconds):(this.pausedAtTick+=t.length,this.lastTick+=t.length),t.remainingSeconds=0,this.currentActivityPointer++,t=this.workoutTimeline[this.currentActivityPointer],e=!0):t.remainingSeconds<t.length&&(this.pausedAtTick+=t.remainingSeconds,this.lastTick+=t.remainingSeconds,t.remainingSeconds=0,e=!0),e&&this.publishCurrentActivity()}onTick(e){this.lastTick=this.calculateCounter(e);let t=this.workoutTimeline[this.currentActivityPointer],o=t.finishTimestamp-this.lastTick;t.remainingSeconds=o,o===0&&this.currentActivityPointer++,this.currentActivityPointer<this.workoutTimeline.length?this.publishCurrentActivity():(this.stop(),this.currentActivityPointer--,this.publishFinalActivity())}publishCurrentActivity(){postMessage({workoutActivity:this.workoutTimeline[this.currentActivityPointer],isWorkoutFinished:!1})}publishFinalActivity(){postMessage({workoutActivity:this.workoutTimeline[this.workoutTimeline.length-1],isWorkoutFinished:!0})}calculateCounter(e){return this.pausedAtTick+e}createWorkoutTimeline(){let e=0;this.activeWorkout.schedule.preparationTime&&(e+=this.activeWorkout.schedule.preparationTime,this.workoutTimeline.push({type:0,finishTimestamp:e,remainingSeconds:this.activeWorkout.schedule.preparationTime,length:this.activeWorkout.schedule.preparationTime,set:1,activity:1}));for(let t=0;t<this.activeWorkout.schedule.numberOfSets;t++)for(let o=0;o<this.activeWorkout.schedule.numberOfExercises;o++)e+=this.activeWorkout.schedule.workoutTime,this.workoutTimeline.push({type:1,finishTimestamp:e,remainingSeconds:this.activeWorkout.schedule.workoutTime,length:this.activeWorkout.schedule.workoutTime,set:t+1,activity:o+1}),this.activeWorkout.schedule.restTimeBetweenSets>0?o<this.activeWorkout.schedule.numberOfExercises-1?(e+=this.activeWorkout.schedule.restTime,this.workoutTimeline.push({type:2,finishTimestamp:e,remainingSeconds:this.activeWorkout.schedule.restTime,length:this.activeWorkout.schedule.restTime,set:t+1,activity:o+1})):t<this.activeWorkout.schedule.numberOfSets-1&&(e+=this.activeWorkout.schedule.restTimeBetweenSets,this.workoutTimeline.push({type:3,finishTimestamp:e,remainingSeconds:this.activeWorkout.schedule.restTimeBetweenSets,length:this.activeWorkout.schedule.restTimeBetweenSets,set:t+1,activity:o+1})):(e+=this.activeWorkout.schedule.restTime,this.workoutTimeline.push({type:2,finishTimestamp:e,remainingSeconds:this.activeWorkout.schedule.restTime,length:this.activeWorkout.schedule.restTime,set:t+1,activity:o+1}))}};if(typeof Worker<"u"){let r;addEventListener("message",({data:e})=>{switch(e?.command){case 0:e.workout&&(r=new F(e?.workout),r.start());break;case 1:r?.stop();break;case 2:r?.pause();break;case 3:r?.resume();break;case 4:r?.rewind();break;case 5:r?.forward();break;default:console.log(`Unknown command: ${e}`)}})}export{ee as WorkoutRunnerCommand};
